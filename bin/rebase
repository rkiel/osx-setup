#!/usr/bin/env ruby

raise "USAGE: rebase branch" unless ARGV.size == 1

REBASE_BRANCH  = ARGV[0]
FEATURE_BRANCH = `git branch|grep '\*'|sed 's/\*\s*//'`.strip
REMOTE_BRANCH  = `git branch -r|grep origin|grep -v 'HEAD'|grep #{FEATURE_BRANCH}`.strip

raise "invalid feature branch: #{FEATURE_BRANCH}" if ['master','develop'].include? FEATURE_BRANCH

def run_cmd ( cmd )
  puts cmd
  success = system cmd
  unless success
    system "git checkout #{FEATURE_BRANCH}"
    raise "error"
  end
end

run_cmd "git checkout #{REBASE_BRANCH}"
run_cmd "git pull origin #{REBASE_BRANCH}"
run_cmd "git checkout #{FEATURE_BRANCH}"
run_cmd "git rebase #{REBASE_BRANCH}"

if REMOTE_BRANCH != ""
  run_cmd "git push origin :#{FEATURE_BRANCH}"
end

run_cmd "git push origin #{FEATURE_BRANCH}"
